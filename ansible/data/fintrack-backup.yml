- name: Backup PostgreSQL database from financetrack-postgres-1 container
  hosts: all
  become: yes

  vars:
    pg_user: "postgres"
    pg_password: "rahasia"
    pg_database: "financetrack"
    container_name: "financetrack-postgres-1"
    backup_dir: "/home/haqqi/app/Financetrack/backup"
    backup_file_prefix: "financetrack_backup"
    backup_file_suffix: ".dump"
    retention_days: 7

  tasks:
    - name: Create backup directory on host if not exists
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'

    - name: Set current date for backup filename
      set_fact:
        backup_date: "{{ '%02d%02d%s' | format(ansible_date_time.day|int, ansible_date_time.month|int, ansible_date_time.year }}"
    
    - name: Set backup file name with date
      set_fact:
        backup_file: "{{ backup_date }}_{{ backup_file_prefix }}{{ backup_file_suffix }}"

    - name: Run pg_dump inside the Docker container
      command: >
        docker exec {{ container_name }}
        pg_dump -U {{ pg_user }}
        -F c -b -v
        -f /tmp/{{ backup_file }}
        {{ pg_database }}
      environment:
        PGPASSWORD: "{{ pg_password }}"

    - name: Copy backup file from container to host
      command: >
        docker cp {{ container_name }}:/tmp/{{ backup_file }} {{ backup_dir }}/{{ backup_file }}

    - name: Remove backup file inside container to clean up
      command: >
        docker exec {{ container_name }} rm -f /tmp/{{ backup_file }}

    - name: Remove backup files older than retention period
      find:
        paths: "{{ backup_dir }}"
        patterns: "{{ backup_file_prefix }}*.dump"
        age: "{{ retention_days }}d"
        age_stamp: "mtime"
      register: old_backups

    - name: Delete old backup files
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_backups.files }}"
      when: old_backups.matched > 0

    - name: Show backup file location
      debug:
        msg: "Backup file saved at {{ backup_dir }}/{{ backup_file }}"

